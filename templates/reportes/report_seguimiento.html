{% extends 'base/base.html' %}

{% load sitetree %}
{% load mathfilters %}
{% block title %}
Reportes
{% endblock %}

{% block extrajs %}


		<script type="text/javascript">



$( document ).ready(function() {



$('#Tabla_filter').find("input").css("display", "none");  /// desaparezco el input de busqueda
$('#Tabla_filter').find("input").val($('').val())
$('#Tabla_filter').find("input").val($('#list_estados').val()) // asigno al input de busqueda el primer valor del select
$('#Tabla_filter').find("input").trigger('keyup');
Calcular();

/////////////////////////////////////////////////1111////////////////////////////////////////////////////////////////////

var des=10;

var ctx1 = $('#chart_uno');

var myLineChart = new Chart(ctx1, {
    type: 'line',
    data: {
        labels: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
        datasets: [{
         label: "N° de Actividades Planificadas (Acumuladas)",

         data:  {{ ValMesesAcum }},

         borderColor: ['rgba(54, 162, 235, 1)'],
		 backgroundColor: ['rgba(240, 240, 240, 0)'],
		 pointBackgroundColor: "rgba(54, 162, 235, 1)",
		 pointBorderColor: "rgba(54, 162, 235, 1)",
		 pointHoverBackgroundColor:"rgba(52,108,176,1)",
		 pointHoverBorderColor: "rgba(52,108,176,1)",
   		 pointHoverBorderWidth: 2,
   		 pointHoverRadius:6,
		 borderWidth: 2,
		 pointBorderWidth:1,
		 pointRadius: 4
		},{

		 label: "N° de Actividades Ejecutadas (Acumuladas) " ,

         data: {{ ValMesesAcumEjec }},

         borderColor: ['rgba(255, 104, 136, 1)'],
		 backgroundColor: ['rgba(240, 240, 240, 0)'],
		 pointBackgroundColor: "rgba(255,104,136,1)",
		 pointBorderColor: "rgba(255,104,136,1)",
		 pointHoverBackgroundColor:"rgba(255,45,87,1)",
		 pointHoverBorderColor: "rgba(255,45,87,1)",
   		 pointHoverBorderWidth: 2,
   		 pointHoverRadius:6,
		 borderWidth: 2,
		 pointBorderWidth:1,
		 pointRadius: 4

		},{

 		label: "Desviación: {{ ValDesviacion }}% " ,

         data: [],
          borderColor: ['rgba(128, 128, 128, 1)'],
          backgroundColor: ['rgba(128, 128, 128, 1)'],
          fontStyle:'bold',



        }]
     },
    options: {
			 title: {
					display: true,
					text: 'Curva de ejecución actividades programadas (acumulada)'
				},
	           legend: {
           		 display: true,


         		},


			 plugins: {
			  datalabels: {
				anchor: 'end',
				align: 'top',
				formatter: Math.round,
				color: '#a7a7a7',
				font: {
				  size: '10'

				}
			  }
			},


			   scales: {
				yAxes: [{
					ticks: {
						//suggestedMin: 0,
						//suggestedMax: 10,
						 beginAtZero: true,
					}
				}]
     		   },


    },



});


$("#download").click(function(){
  /*Get image of canvas element*/
  var url_base64jp = document.getElementById("chart_uno").toDataURL("image/jpg");
  /*get download button (tag: <a></a>) */
  var a =  document.getElementById("download");
  /*insert chart image url to download button (tag: <a></a>) */
  a.href = url_base64jp;
});




	$("#downloadTable").click(function(){


  $("#Tabla").table2excel({
    // exclude CSS class
    exclude:".noExl",
    name:"Worksheet Name",
    filename:"EstadoCumplimiento",//do not include extension
    fileext:".xls" // file extension
  });
});



   	 // JS modal actualiza Registro
   $(".update").each(function () {
   $(this).modalForm({formURL: $(this).data('id'),  modalID: $("#modalUpdate")});

    });

         // Js Muestra/Oculta Mensaje Success
   	 $(".alert").fadeTo(2000, 500).slideUp( "slow", function() {
     $(this).remove();
  });

});


$('#datatable-default').on('click', '.descripcion_actividad', function () {
    $('#txt_obs_campo_expand').val($(this).parents('tr').find('td:nth-child(2)').text())
    $('#observacion_center').modal('toggle');
});

$('#datatable-default').on('click', '.descripcion_objetivo', function () {
    $('#txt_obs_campo_expand').val($(this).parents('tr').find('td:nth-child(3)').text())
    $('#observacion_center').modal('toggle');
});

$('#datatable-default').on('click', '.descripcion_justificacion', function () {
    $('#txt_obs_campo_expand').val($(this).parents('tr').find('td:nth-child(17)').text())
    $('#observacion_center').modal('toggle');
});



    $("#list_estados").change(function () {
    $('#Tabla_filter').find("input").val($(this).val())
    $('#Tabla_filter').find("input").trigger('keyup');
    Calcular();
        });

	function Calcular() {

		var sum1 = 0;
		$(".countTotal").each(function(){
		sum1 += parseInt($(this).html()) || 0;
		$('.totalCountVal').text(sum1.toFixed(0));
		});


		var sum2 = 0;
		$(".CountEliminadas").each(function(){
		sum2 += parseInt($(this).html()) || 0;
		$('.CountEliminadasVal').text(sum2.toFixed(0));
		$('.CountEliminadasValPer').text(((sum2*100)/sum1).toFixed(2));
		});

		var sum3 = 0;
		$(".CountSinMovimiento").each(function(){
		sum3 += parseInt($(this).html()) || 0;
		$('.CountSinMovimientoVal').text(sum3.toFixed(0));
		$('.CountSinMovimientoValPer').text(((sum3*100)/sum1).toFixed(2));
		});

		var sum4 = 0;
		$(".CountConRetraso").each(function(){
		sum4 += parseInt($(this).html()) || 0;
		$('.CountConRetrasoVal').text(sum4.toFixed(0));
		$('.CountConRetrasoValPer').text(((sum4*100)/sum1).toFixed(2));
		});

		var sum5 = 0;
		$(".CountFinalizadas").each(function(){
		sum5 += parseInt($(this).html()) || 0;
		$('.CountFinalizadasVal').text(sum5.toFixed(0));
		$('.CountFinalizadasValPer').text(((sum5*100)/sum1).toFixed(2));
		});

		var sum6 = 0;
		$(".CountNoIniciadas").each(function(){
		sum6 += parseInt($(this).html()) || 0;
		$('.CountNoIniciadasVal').text(sum6.toFixed(0));
		$('.CountNoIniciadasValPer').text(((sum6*100)/sum1).toFixed(2));
		});

		var sum7 = 0;
		$(".CountEnCurso").each(function(){
		sum7 += parseInt($(this).html()) || 0;
		$('.CountEnCursoVal').text(sum7.toFixed(0));
		$('.CountEnCursoValPer').text(((sum7*100)/sum1).toFixed(2));
		});



 	}


  $("#Tabla").dataTable({
        "processing": true,
        "stateSave": true,
		paging: false,
        destroy: true,

        "language": {
            "lengthMenu": " _MENU_ registros por página",
            "zeroRecords": "No se encontraron resultados",

            "info": "",
            "infoEmpty": "No hay registros disponibles",
            "infoFiltered": "",
            "paginate": {
                "previous": "Anterior",
                "next": "Siguiente"
            },
            "search": ""
        },






    });





		</script>

      <script>

      </script>


	{% endblock %}


{% block content %}

{% if messages %}
		  {% for message in messages %}

			<div style="border-radius:0;" {% if message.tags %} id="danger-alert" class="{{request.session.message_class}} fade show mb-0" role="alert" {% endif %}>
			  {{ message }}
			  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
				<span aria-hidden="true">&times;</span>
			  </button>
			</div>

		  {% endfor %}

	{% endif %}



<div class="tabs tabs-primary">
								<ul class="nav nav-tabs">
									<li class="active">
										<a aria-expanded="false" href="#popular1" data-toggle="tab"> Gráfico C.E.A.P</a>
									</li>
									<li >
										<a aria-expanded="true" href="#recent1" data-toggle="tab">Datos C.E.A.P</a>
									</li>
									<li>
										<a aria-expanded="true" href="#cumplimiento1" data-toggle="tab">Estado Cumplimiento</a>
									</li>
								</ul>



								<div class="tab-content">






<!--#############################################################################################################3-->
									<div class="tab-pane active" id="popular1">


									<section class="panel">

									<div style="text-align:right;">
											<a id="download" style="width:30px; height:30px;"  name="download"  download="Curva_de_ejecucion_actividades_programadas.jpg" href="" class="btn btn-sm btn-success" title="Descargar Gráfico" data-toggle="tooltip" data-original-title="Tooltip on bottom" data-placement="top">
											<span style="margin-left:-2px;" class="fa fa-download"></span>
											</a>
									</div>
									<div class="panel-body">
										<canvas id="chart_uno" ></canvas>

									</div>

									</section>

								</div>


<!--xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx-->


									<div class="tab-pane" id="recent1">



										<section class="panel">



							<div style="text-align:right;">
								 <a  type="button" style="width:30px; height:30px; "  class="create btn btn-sm btn-success" href="{% url 'export_xls' %}"  name="button" title="Descargar Tabla en MS Excel" data-toggle="tooltip" data-original-title="Tooltip on bottom" data-placement="top">
									 <span style="margin-left:-1px; " class="fa fa-file-excel-o"></span></a>
							</div>


									<!--<a href="#" class="fa fa-times"></a>-->

							<div class="panel-body">
								<table class="table table-bordered table-striped mb-none" id="datatable-default">
									<thead>
										<tr style="font-size:11px;">
											<th>N°</th>
											<th>Descripción Actividad</th>
											<th>Objetivo Vinculado</th>
											<th>Periodicidad</th>
											<th>Producto Estadístico</th>
											<th>Hora x actividad</th>
											<th>Volumen</th>
											<th>N° Personas Asignadas</th>
											<th>Total Horas</th>
											<th>Cargo</th>
											<th >Fecha Inicio</th>
											<th >Fecha Término</th>
											<th>Estado Actividad.</th>
											<th>Fecha Real de Finalización</th>
											<th>Reprogramación Fecha de Inicio</th>
											<th>Reprogramación Fecha de Término</th>
											<th>Justificación Desviación</th>
											<th>Dependencia 1</th>
											<th>Dependencia 2</th>
											<th>Área</th>
											<th>Eje</th>



										</tr>
									</thead>
									<tbody>

                                            {% for actividad in object_list %}
                                                <tr style="font-size:11px;">
													<td> {{ forloop.counter }}</td>
                                                    <td class="descripcion_actividad"  style="cursor:pointer; max-width: 100px; overflow: hidden;  display: table-cell;  text-overflow: ellipsis;  border: solid 1px #dddddd; white-space: nowrap;"> {{ actividad.descripcion_actividad }} </td>
													 <td class="descripcion_objetivo"  style="cursor:pointer; max-width: 100px; overflow: hidden;  display: table-cell;  text-overflow: ellipsis;  border: solid 1px #dddddd; white-space: nowrap;"> {% if actividad.id_objetivo_operativo != None %} {{actividad.id_objetivo_operativo}} {% elif actividad.id_objetivo_tactico != None %} {{actividad.id_objetivo_tactico}} {% elif actividad.id_objetivo_tacticotn != None %} {{actividad.id_objetivo_tacticotn}} {% endif %} </td>
													<td> {{ actividad.id_periodicidad}} </td>
													<td> {{ actividad.id_producto_estadistico}} </td>
													<td> {{ actividad.horas_actividad}} </td>
													<td> {{ actividad.volumen}} </td>
													<td> {{ actividad.personas_asignadas}} </td>
													<td> {{ actividad.total_horas}} </td>
													<td> {{ actividad.id_familia_cargo}} </td>
													<td> {{ actividad.fecha_inicio_actividad}} </td>
													<td> {{ actividad.fecha_termino_actividad}} </td>
													<td> {{ actividad.id_estado_actividad}} </td>
													<td> {% if actividad.fecha_real_termino == None %} {% else %} {{ actividad.fecha_real_termino}} {% endif %} </td>
													<td> {% if actividad.fecha_reprogramacion_inicio == None %} {% else %} {{ actividad.fecha_reprogramacion_inicio}} {% endif %} </td>
													<td>{% if actividad.fecha_reprogramacion_termino == None %} {% else %} {{ actividad.fecha_reprogramacion_termino}} {% endif %} </td>
													<td class="descripcion_justificacion"  style="cursor:pointer; max-width: 100px; overflow: hidden;  display: table-cell;  text-overflow: ellipsis;  border: solid 1px #dddddd; white-space: nowrap;"> {% if actividad.justificacion == None %} {% else %} {{ actividad.justificacion}} {% endif %}  </td>
													<td>
														{% if actividad.id_controlador.nivel_inicial == 4 %} {{actividad.id_controlador.id_jefatura.id_nivel.id_cuarto_nivel.tercer_nivel.segundo_nivel}}
														{% elif actividad.id_controlador.nivel_inicial == 3 %} {{actividad.id_controlador.id_jefatura.id_nivel.id_tercer_nivel.id_segundo_nivel}}
														{% elif actividad.id_controlador.nivel_inicial == 2 %} {{actividad.id_controlador.id_jefatura.id_nivel.id_segundo_nivel}}
														{% endif %}
													</td>
													<td>
														{% if actividad.id_controlador.nivel_inicial == 4 %} {{actividad.id_controlador.id_jefatura.id_nivel.id_cuarto_nivel.tercer_nivel}}
														{% elif actividad.id_controlador.nivel_inicial == 3 %} {{actividad.id_controlador.id_jefatura.id_nivel.id_tercer_nivel}}
														{% elif actividad.id_controlador.nivel_inicial == 2 %} -
														{% endif %}
													</td>

													<td>

														{% if actividad.id_controlador.nivel_inicial == 4 %} {{actividad.id_controlador.id_jefatura.id_nivel.id_cuarto_nivel}}
														{% elif actividad.id_controlador.nivel_inicial == 3 %} -
														{% elif actividad.id_controlador.nivel_inicial == 2 %} -
														{% endif %}
													</td>

													<td>
														{% if actividad.id_objetivo_operativo != None %} {{actividad.id_objetivo_operativo.id_objetivo_tacticotn.id_objetivo_tactico.id_objetivo_estrategico.ges_eje}}
														{% elif actividad.id_objetivo_tacticotn != None %} {{actividad.id_objetivo_tacticotn.id_objetivo_tactico.id_objetivo_estrategico.ges_eje}}
														{% elif actividad.id_objetivo_tactico != None %} {{actividad.id_objetivo_tactico.id_objetivo_estrategico.ges_eje}}
														{% endif %}
													</td>



                                                </tr>
                                            {% endfor %}


									</tbody>
								</table>

							</div>
						</section>
									</div>


<!--xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx-->



									<div class="tab-pane" id="cumplimiento1">
										<section class="panel">

											<div style="text-align:right; position:relative; z-index:1;;">
											<button id="downloadTable" style="width:30px; height:30px;"  name="downloadTable" title="Descargar Tabla en MS Excel" class="btn btn-sm btn-success" data-toggle="tooltip" data-original-title="Tooltip on bottom" data-placement="top">
											<span style="margin-left:-1px;" class="fa fa-file-excel-o"></span>
											</button>

									</div>


											<div class="panel-body" style="margin-top:-40px;">
							<div class="form-group">
							<label>Seleccione Unidad Nivel Superior</label>
							<select class="form-control" id="list_estados" style="max-width:500px;">

  {% for actividad_count in object_unidades %}
                             <option value=		{% if actividad_count.id_controlador__nivel_inicial == 4 %} {{ actividad_count.id_controlador__id_jefatura__id_nivel__id_cuarto_nivel__tercer_nivel__descripcion_nivel }} {% endif %}
														{% if actividad_count.id_controlador__nivel_inicial == 3 %} {{ actividad_count.id_controlador__id_jefatura__id_nivel__id_tercer_nivel__segundo_nivel__descripcion_nivel }} {% endif %}
														{% if actividad_count.id_controlador__nivel_inicial == 2 %} {{ actividad_count.id_controlador__id_jefatura__id_nivel__id_segundo_nivel__primer_nivel__descripcion_nivel }} {% endif %}>


		{% if actividad_count.id_controlador__nivel_inicial == 4 %} {{ actividad_count.id_controlador__id_jefatura__id_nivel__id_cuarto_nivel__tercer_nivel__descripcion_nivel }} {% endif %}
														{% if actividad_count.id_controlador__nivel_inicial == 3 %} {{ actividad_count.id_controlador__id_jefatura__id_nivel__id_tercer_nivel__segundo_nivel__descripcion_nivel }} {% endif %}
														{% if actividad_count.id_controlador__nivel_inicial == 2 %} {{ actividad_count.id_controlador__id_jefatura__id_nivel__id_segundo_nivel__primer_nivel__descripcion_nivel }} {% endif %}

								 {% endfor %}
							 </option>
								<option value="">Todos</option>


                            </select>

						    </div>



								<table class="table table-bordered table-striped mb-none" id="Tabla"  data-page-length='1000'>
									<thead>
										<tr style="font-size:11px;">

											<th colspan="1" style="background-color:#bec1cb; " ></th>
											<th style="text-align:center; background-color:#1e7799; color:#ffffff;" colspan="2">No Iniciadas</th>
											<th style="text-align:center; background-color:#70ad47; color:#ffffff;" colspan="2">Finalizadas</th>
											<th style="text-align:center; background-color:#6783b5; color:#ffffff;" colspan="2">En Curso</th>
											<th style="text-align:center; background-color:#808080; color:#ffffff;" colspan="2">Con Retraso </th>
											<th style="text-align:center; background-color:#e6ac00; color:#ffffff;" colspan="2">Sin Movimiento </th>
											<th style="text-align:center; background-color:#ed7d31; color:#ffffff;" colspan="2">Eliminadas </th>
											<th  style="text-align:center; background-color:#408080; color:#ffffff;"> Total</th>

										</tr>

											<tr style="font-size:11px;">
											<th class="noExl" style="display:none;" >Nivel</th>
											<th class="noExl" style="display:none;">Superior</th>
											<th>Unidades</th>
											<th>N° Total Actividades</th><th>% Total Actividades</th>
											<th>N° Total Actividades</th><th>% Total Actividades</th>
											<th>N° Total Actividades</th><th>% Total Actividades</th>
											<th>N° Total Actividades</th><th>% Total Actividades</th>
											<th>N° Total Actividades</th><th>% Total Actividades</th>
											<th>N° Total Actividades</th><th>% Total Actividades</th>
											<th>Total </th>

										</tr>

									</thead>
									<tbody >

                                            {% for actividad_count in object_count %}
                                                <tr style="font-size:11px;">
													<td class="noExl"  style="display:none;"> {{ actividad_count.id_controlador__nivel_inicial }} </td>
													<td class="noExl"  style="display:none;">
														{% if actividad_count.id_controlador__nivel_inicial == 4 %} {{ actividad_count.id_controlador__id_jefatura__id_nivel__id_cuarto_nivel__tercer_nivel__descripcion_nivel }} {% endif %}
														{% if actividad_count.id_controlador__nivel_inicial == 3 %} {{ actividad_count.id_controlador__id_jefatura__id_nivel__id_tercer_nivel__segundo_nivel__descripcion_nivel }} {% endif %}
														{% if actividad_count.id_controlador__nivel_inicial == 2 %} {{ actividad_count.id_controlador__id_jefatura__id_nivel__id_segundo_nivel__primer_nivel__descripcion_nivel }} {% endif %}
													</td>
													<td> {{ actividad_count.id_controlador__id_jefatura__id_nivel__descripcion_nivel }} </td>
													<td><span class="CountNoIniciadas"> {{ actividad_count.CountNoIniciadas }}</span></td><td>{{ actividad_count.CountNoIniciadas|mul:100 |div:actividad_count.CountTotal }}% </td>
													<td><span class="CountFinalizadas">{{ actividad_count.CountFinalizadas }}</span> </td><td>{{ actividad_count.CountFinalizadas|mul:100 |div:actividad_count.CountTotal }}% </td>
													<td><span class="CountEnCurso">{{ actividad_count.CountEnCurso }}</span> </td><td>{{ actividad_count.CountEnCurso|mul:100 |div:actividad_count.CountTotal }}% </td>
													<td><span class="CountConRetraso">{{ actividad_count.CountConRetraso }}</span> </td><td>{{ actividad_count.CountConRetraso|mul:100 |div:actividad_count.CountTotal }}% </td>
													<td><span class="CountSinMovimiento">{{ actividad_count.CountSinMovimiento }}</span> </td><td>{{ actividad_count.CountSinMovimiento|mul:100 |div:actividad_count.CountTotal }}% </td>
													<td><span class="CountEliminadas">{{ actividad_count.CountEliminadas }} </span></td><td>{{ actividad_count.CountEliminadas|mul:100 |div:actividad_count.CountTotal }}% </td>
													<td><span class="countTotal">{{ actividad_count.CountTotal }} </span></td>




                                                </tr>
                                            {% endfor %}

									</tbody>

									<tbody >


                                                <tr style="font-size:11px;">
													<td class="noExl"  style="display:none;">  </td>
													<td class="noExl"  style="display:none;">

													</td>
													<td style="background-color:#bec1cb; font-weight: bold; color:#4f4f4f; width:150px;"> Total General</td>
													<td style="background-color:#1e7799; font-weight: bold; color:#ffffff;"><span class="CountNoIniciadasVal"></span> </td><td style="background-color:#1e7799; font-weight: bold; color:#ffffff;"> <span class="CountNoIniciadasValPer"></span>%</td>
													<td style="background-color:#70ad47; font-weight: bold; color:#ffffff;"><span class="CountFinalizadasVal"></span> </td><td style="background-color:#70ad47; font-weight: bold; color:#ffffff;"> <span class="CountFinalizadasValPer"></span>%</td>
													<td style="background-color:#6783b5; font-weight: bold; color:#ffffff;"><span class="CountEnCursoVal"></span> </td><td style="background-color:#6783b5; font-weight: bold; color:#ffffff;"> <span class="CountEnCursoValPer"></span>%</td>
													<td style="background-color:#808080; font-weight: bold; color:#ffffff;"><span class="CountConRetrasoVal"></span> </td><td style="background-color:#808080; font-weight: bold; color:#ffffff;"> <span class="CountConRetrasoValPer"></span>%</td>
													<td style="background-color:#e6ac00; font-weight: bold; color:#ffffff;"><span class="CountSinMovimientoVal"></span> </td><td style="background-color:#e6ac00; font-weight: bold; color:#ffffff;"> <span class="CountSinMovimientoValPer"></span>%</td>
													<td style="background-color:#ed7d31; font-weight: bold; color:#ffffff;"><span class="CountEliminadasVal"></span></td><td style="background-color:#ed7d31; font-weight: bold; color:#ffffff;"><span class="CountEliminadasValPer"></span>%</td>
													<td style="background-color:#408080; font-weight: bold; color:#ffffff;" ><span class="totalCountVal"></span></td>




                                                </tr>


									</tbody>




								</table>




							</div>



										</section>
									</div>





								</div>
								</div>



<!--Fin cabecera del modal -->
        <div class="modal fade" id="observacion_center" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">

				<header class="panel-heading">
				<div class="panel-actions">
				<a class="fa fa-times" data-dismiss="modal"></a>
				</div>
				<h2 class="panel-title">Detalle</h2>
			</header>

              <div class="modal-body">
               	<textarea id="txt_obs_campo_expand" rows="15" cols="80" class="form-control" style="width:100%;resize: none; " maxlength="5000" readonly  ></textarea>

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>

              </div>
            </div>
          </div>

        </div>





	{% endblock %}
